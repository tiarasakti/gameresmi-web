<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Upload • gameresmi</title>
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui;margin:0;background:#0b1020;color:#e9eeff}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    h1{margin:0 0 10px;font-size:20px}
    label{display:block;font-size:12px;opacity:.9;margin:12px 0 6px}
    input,textarea,button,select{font:inherit}
    input,textarea,select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);
      background:#0e1630;color:#e9eeff;box-sizing:border-box
    }
    textarea{min-height:88px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{opacity:.8;font-size:12px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:0;background:#4aa3ff;color:#071022;cursor:pointer;font-weight:700;text-decoration:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .secondary{background:rgba(255,255,255,.10);color:#e9eeff;border:1px solid rgba(255,255,255,.12)}
    .danger{background:#ff5b6e;color:#1a0b10}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar > div{height:100%;width:0%;background:#4aa3ff}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .preview{
      margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap
    }
    .preview img{
      width:120px;height:120px;object-fit:cover;border-radius:14px;
      border:1px solid rgba(255,255,255,.15);background:#0e1630
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Admin Upload (R2 Multipart + D1 Upsert)</h1>
          <div class="muted">Chunk: <span class="pill">20 MB</span> • Key tetap: <span class="pill mono">games/&lt;slug&gt;.&lt;ext&gt;</span></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn secondary" href="/admin/manage.html">Manage</a>
          <a class="btn secondary" href="/">Home</a>
        </div>
      </div>

      <label>ADMIN_TOKEN (Bearer)</label>
      <input id="token" type="password" placeholder="Tempel token di sini (tidak disimpan server)" />

      <label>File game</label>
      <input id="file" type="file" />

      <div class="row">
        <div>
          <label>Slug (auto, bisa edit)</label>
          <input id="slug" placeholder="mis: gta-san-andreas" />
        </div>
        <div>
          <label>File key (terkunci)</label>
          <input id="key" readonly />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Title</label>
          <input id="title" placeholder="Judul game" />
        </div>

        <div>
          <label>Cover (upload dari PC)</label>
          <input id="coverFile" type="file" accept="image/*" />
          <div class="muted" style="margin-top:6px">Cover akan di-upload ke R2 dan otomatis jadi <span class="mono">cover_url</span>.</div>
        </div>
      </div>

      <div class="preview" id="coverPreviewWrap" style="display:none">
        <img id="coverPreview" alt="cover preview" />
        <div style="min-width:260px;flex:1">
          <div class="muted">cover_url (otomatis)</div>
          <input id="cover_url" class="mono" readonly />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Genre</label>
          <div style="display:flex;gap:8px">
            <select id="genreSelect"></select>
            <button id="btnAddGenre" class="btn secondary" type="button">+ Genre</button>
          </div>
          <div class="muted" style="margin-top:6px">Dropdown bisa ditambah sesuai kebutuhan.</div>
        </div>

        <div>
          <label>Platform (opsional)</label>
          <input id="platform" placeholder="PC, PS2, Switch, ..." />
        </div>

        <div>
          <label>Publish?</label>
          <select id="is_published">
            <option value="1" selected>Ya</option>
            <option value="0">Tidak (draft)</option>
          </select>
        </div>
      </div>

      <label>Deskripsi singkat (opsional)</label>
      <textarea id="short_desc" placeholder="Ringkasan singkat untuk grid"></textarea>

      <div style="display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <button id="btnUpload" class="btn">Upload</button>
        <button id="btnAbort" class="btn danger" disabled>Abort</button>
        <span id="status" class="muted"></span>
      </div>

      <div style="margin-top:12px" class="bar"><div id="barFill"></div></div>

      <div class="muted" style="margin-top:8px;display:flex;gap:14px;flex-wrap:wrap">
        <div>Uploaded: <span class="mono" id="bytes">0</span> / <span class="mono" id="total">0</span></div>
        <div>Speed: <span class="mono" id="speed">0 MB/s</span></div>
        <div>ETA: <span class="mono" id="eta">-</span></div>
      </div>
    </div>
  </div>

<script>
  const CHUNK_SIZE = 20 * 1024 * 1024; // 20MB
  let current = { key: null, uploadId: null, abortRequested: false };

  const $ = (id) => document.getElementById(id);
  const barFill = $("barFill");

  function bytesFmt(n) {
    const u = ["B","KB","MB","GB","TB"];
    let i = 0, x = Number(n || 0);
    while (x >= 1024 && i < u.length-1) { x /= 1024; i++; }
    return x.toFixed(i === 0 ? 0 : 2) + " " + u[i];
  }

  function mbpsFmt(bytesPerSec) {
    const mb = bytesPerSec / (1024 * 1024);
    return `${mb.toFixed(2)} MB/s`;
  }

  function etaFmt(seconds) {
    if (!Number.isFinite(seconds) || seconds < 0) return "-";
    const s = Math.ceil(seconds);
    const m = Math.floor(s / 60);
    const r = s % 60;
    if (m <= 0) return `${r}s`;
    return `${m}m ${r}s`;
  }

  function slugify(s) {
    return String(s || "")
      .normalize("NFKD").replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
  }

  function splitExt(filename) {
    const name = String(filename || "");
    const lower = name.toLowerCase();
    const double = [".tar.gz", ".tar.xz", ".tar.zst"];
    for (const d of double) {
      if (lower.endsWith(d)) return { base: name.slice(0, -d.length), ext: d.slice(1) };
    }
    const i = name.lastIndexOf(".");
    if (i <= 0) return { base: name, ext: "" };
    return { base: name.slice(0, i), ext: name.slice(i+1) };
  }

  function toTitleFromFilename(base) {
    return String(base || "")
      .replace(/[_\.]+/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .split(" ")
      .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : "")
      .join(" ");
  }

  function updateKey() {
    const slug = slugify($("slug").value);
    $("slug").value = slug;

    const file = $("file").files[0];
    const { ext } = file ? splitExt(file.name) : { ext: "" };
    const safeExt = (ext || "bin").toLowerCase();

    $("key").value = slug ? `games/${slug}.${safeExt}` : "";
  }

  // ===== Genre dropdown + add (localStorage) =====
  const GENRE_KEY = "admin_genres_v1";
  const DEFAULT_GENRES = ["Action","RPG","Adventure","Simulation","Strategy","Racing","Sports","Horror","Puzzle","Fighting","Shooter","Indie"];

  function loadGenres() {
    try {
      const raw = localStorage.getItem(GENRE_KEY);
      const arr = raw ? JSON.parse(raw) : null;
      if (Array.isArray(arr) && arr.length) return arr;
    } catch {}
    return DEFAULT_GENRES;
  }

  function saveGenres(arr) {
    localStorage.setItem(GENRE_KEY, JSON.stringify(arr));
  }

  function renderGenres(selected = "") {
    const sel = $("genreSelect");
    const genres = loadGenres();
    sel.innerHTML = `<option value="">(kosong)</option>` + genres
      .map(g => `<option value="${g}">${g}</option>`)
      .join("");
    sel.value = selected || "";
  }

  $("btnAddGenre").addEventListener("click", () => {
    const name = prompt("Tambah genre baru (contoh: Visual Novel)");
    if (!name) return;
    const g = String(name).trim();
    if (!g) return;

    const genres = loadGenres();
    if (!genres.includes(g)) {
      genres.push(g);
      genres.sort((a,b) => a.localeCompare(b));
      saveGenres(genres);
    }
    renderGenres(g);
  });

  // ===== API helper =====
  async function api(path, { method="GET", token, body, headers={} } = {}) {
    const h = new Headers(headers);
    h.set("Authorization", `Bearer ${token}`);

    const isBlob = body && (body instanceof Blob);
    if (body && !isBlob && !(body instanceof FormData)) {
      h.set("content-type", "application/json; charset=utf-8");
    }

    const res = await fetch(path, {
      method,
      headers: h,
      body: body ? (isBlob ? body : (body instanceof FormData ? body : JSON.stringify(body))) : undefined,
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = (data && data.error) ? data.error : text || res.statusText;
      throw new Error(`${res.status} ${msg}`);
    }
    return data;
  }

  // ===== Cover preview =====
  $("coverFile").addEventListener("change", () => {
    const f = $("coverFile").files[0];
    if (!f) {
      $("coverPreviewWrap").style.display = "none";
      $("cover_url").value = "";
      return;
    }
    $("coverPreview").src = URL.createObjectURL(f);
    $("coverPreviewWrap").style.display = "flex";
    $("cover_url").value = "(akan terisi setelah upload)";
  });

  // ===== File change =====
  $("file").addEventListener("change", () => {
    const f = $("file").files[0];
    if (!f) return;

    const { base, ext } = splitExt(f.name);
    const slug = slugify(base);
    $("slug").value = slug;
    $("title").value = $("title").value.trim() ? $("title").value : toTitleFromFilename(base);
    $("key").value = `games/${slug}.${(ext || "bin").toLowerCase()}`;

    $("total").textContent = bytesFmt(f.size);
    $("bytes").textContent = bytesFmt(0);
    $("speed").textContent = "0 MB/s";
    $("eta").textContent = "-";
    barFill.style.width = "0%";
    $("status").textContent = "";
  });

  $("slug").addEventListener("input", updateKey);

  // ===== Multipart upload =====
  async function uploadSequential(file, token, key, uploadId) {
    const totalParts = Math.ceil(file.size / CHUNK_SIZE);
    const parts = [];
    let uploaded = 0;

    const t0 = performance.now();
    let lastUi = 0;

    for (let i = 0; i < totalParts; i++) {
      if (current.abortRequested) throw new Error("Upload dibatalkan.");

      const partNumber = i + 1;
      const start = i * CHUNK_SIZE;
      const end = Math.min(file.size, start + CHUNK_SIZE);
      const chunk = file.slice(start, end);

      $("status").textContent = `Uploading part ${partNumber}/${totalParts}...`;

      const q = new URLSearchParams({ key, uploadId, partNumber: String(partNumber) });
      const part = await api(`/api/admin/mpu-uploadpart?${q.toString()}`, {
        method: "PUT",
        token,
        body: chunk,
        headers: { "content-type": "application/octet-stream" },
      });

      parts.push(part);
      uploaded += (end - start);

      // UI update (speed + ETA)
      const now = performance.now();
      const elapsed = Math.max(0.001, (now - t0) / 1000);
      const speed = uploaded / elapsed;
      const remaining = Math.max(0, file.size - uploaded);
      const eta = remaining / Math.max(1, speed);

      $("bytes").textContent = bytesFmt(uploaded);
      barFill.style.width = Math.floor((uploaded / file.size) * 100) + "%";

      // jangan terlalu sering update teks (biar smooth)
      if (now - lastUi > 200) {
        $("speed").textContent = mbpsFmt(speed);
        $("eta").textContent = etaFmt(eta);
        lastUi = now;
      }
    }

    // final
    const now = performance.now();
    const elapsed = Math.max(0.001, (now - t0) / 1000);
    const speed = uploaded / elapsed;
    $("speed").textContent = mbpsFmt(speed);
    $("eta").textContent = "0s";

    return parts;
  }

  $("btnAbort").addEventListener("click", async () => {
    const token = $("token").value.trim();
    if (!token) return;

    current.abortRequested = true;
    $("status").textContent = "Aborting...";

    // kalau sudah punya uploadId, abort juga di server
    if (current.key && current.uploadId) {
      try {
        await api("/api/admin/mpu-abort", {
          method: "POST",
          token,
          body: { key: current.key, uploadId: current.uploadId },
        });
      } catch {}
    }

    $("status").textContent = "Aborted.";
    $("btnAbort").disabled = true;
  });

  $("btnUpload").addEventListener("click", async () => {
    const token = $("token").value.trim();
    const file = $("file").files[0];

    const slug = $("slug").value.trim();
    const key = $("key").value.trim();

    if (!token) return alert("ADMIN_TOKEN wajib diisi.");
    if (!file) return alert("Pilih file game dulu.");
    if (!slug || !key) return alert("Slug/key belum valid.");

    $("btnUpload").disabled = true;
    $("btnAbort").disabled = false;
    current.abortRequested = false;
    $("status").textContent = "Starting...";

    try {
      // 0) Upload cover (opsional)
      let cover_url = null;
      const cover = $("coverFile").files[0];
      if (cover) {
        $("status").textContent = "Uploading cover...";
        const fd = new FormData();
        fd.append("slug", slug);
        fd.append("cover", cover, cover.name);

        const cov = await api("/api/admin/cover-upload", {
          method: "POST",
          token,
          body: fd,
        });
        cover_url = cov.cover_url;
        $("coverPreviewWrap").style.display = "flex";
        $("cover_url").value = cover_url;
      } else {
        $("cover_url").value = "";
      }

      // 1) Create MPU
      $("status").textContent = "Creating multipart upload...";
      const created = await api("/api/admin/mpu-create", {
        method: "POST",
        token,
        body: { key, contentType: "application/octet-stream" },
      });

      current.key = created.key;
      current.uploadId = created.uploadId;

      // 2) Upload parts
      const parts = await uploadSequential(file, token, created.key, created.uploadId);

      // 3) Complete MPU
      $("status").textContent = "Completing upload...";
      await api("/api/admin/mpu-complete", {
        method: "POST",
        token,
        body: { key: created.key, uploadId: created.uploadId, parts },
      });

      // 4) Upsert D1
      $("status").textContent = "Saving metadata...";
      const genre = $("genreSelect").value || null;

      const up = await api("/api/admin/game-upsert", {
        method: "POST",
        token,
        body: {
          title: $("title").value.trim() || slug,
          slug,
          genre,
          platform: $("platform").value.trim() || null,
          cover_url: cover_url,
          short_desc: $("short_desc").value.trim() || null,
          is_published: $("is_published").value === "1",
          file_key: created.key,
          file_name: file.name,
          file_size_bytes: file.size,
          sha256: null,
        },
      });

      $("status").textContent = "DONE ✅ (cek Manage untuk lihat list)";
      // reset state upload
      current = { key: null, uploadId: null, abortRequested: false };

    } catch (e) {
      $("status").textContent = "ERROR ❌ " + e.message;
      alert(e.message);
    } finally {
      $("btnUpload").disabled = false;
      $("btnAbort").disabled = true;
    }
  });

  // init genres
  renderGenres("");
</script>
</body>
</html>
