<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Upload • gameresmi</title>
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui;margin:0;background:#0b1020;color:#e9eeff}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    h1{margin:0 0 10px;font-size:20px}
    label{display:block;font-size:12px;opacity:.9;margin:12px 0 6px}
    input,textarea,button,select{font:inherit}
    input,textarea,select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);
      background:#0e1630;color:#e9eeff;box-sizing:border-box
    }
    textarea{min-height:88px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{opacity:.8;font-size:12px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:0;background:#4aa3ff;color:#071022;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .danger{background:#ff5b6e;color:#1a0b10}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar > div{height:100%;width:0%;background:#4aa3ff}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0e1630;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;min-height:80px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin Upload (R2 Multipart + D1 Upsert)</h1>
      <div class="muted">Chunk: <span class="pill">20 MB</span> • Key tetap: <span class="pill mono">games/&lt;slug&gt;.&lt;ext&gt;</span></div>

      <label>ADMIN_TOKEN (Bearer)</label>
      <input id="token" type="password" placeholder="Tempel token di sini (tidak disimpan server)" />

      <label>File game</label>
      <input id="file" type="file" />

      <div class="row">
        <div>
          <label>Slug (auto, bisa edit)</label>
          <input id="slug" placeholder="mis: gta-san-andreas" />
        </div>
        <div>
          <label>File key (terkunci)</label>
          <input id="key" readonly />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Title</label>
          <input id="title" placeholder="Judul game" />
        </div>
        <div>
          <label>Cover URL (opsional)</label>
          <input id="cover_url" placeholder="https://..." />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Genre (opsional)</label>
          <input id="genre" placeholder="Action, RPG, ..." />
        </div>
        <div>
          <label>Platform (opsional)</label>
          <input id="platform" placeholder="PC, PS2, Switch, ..." />
        </div>
        <div>
          <label>Publish?</label>
          <select id="is_published">
            <option value="1" selected>Ya</option>
            <option value="0">Tidak (draft)</option>
          </select>
        </div>
      </div>

      <label>Deskripsi singkat (opsional)</label>
      <textarea id="short_desc" placeholder="Ringkasan singkat untuk grid"></textarea>

      <div style="display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <button id="btnUpload" class="btn">Upload</button>
        <button id="btnAbort" class="btn danger" disabled>Abort</button>
        <span id="status" class="muted"></span>
      </div>

      <div style="margin-top:12px" class="bar"><div id="barFill"></div></div>
      <div class="muted" style="margin-top:8px">
        Uploaded: <span class="mono" id="bytes">0</span> / <span class="mono" id="total">0</span>
      </div>

      <label>Log</label>
      <div id="log" class="log"></div>
    </div>
  </div>

<script>
  const CHUNK_SIZE = 20 * 1024 * 1024; // 20MB (aman jauh di atas minimum multipart 5MB)
  let current = { key: null, uploadId: null };

  const $ = (id) => document.getElementById(id);
  const logEl = $("log");
  const barFill = $("barFill");

  function log(msg) {
    logEl.textContent += msg + "\\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function bytesFmt(n) {
    const u = ["B","KB","MB","GB","TB"];
    let i = 0, x = Number(n || 0);
    while (x >= 1024 && i < u.length-1) { x /= 1024; i++; }
    return x.toFixed(i === 0 ? 0 : 2) + " " + u[i];
  }

  function slugify(s) {
    return String(s || "")
      .normalize("NFKD").replace(/[\\u0300-\\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
  }

  function splitExt(filename) {
    const name = String(filename || "");
    const lower = name.toLowerCase();
    // handle double extensions (opsional)
    const double = [".tar.gz", ".tar.xz", ".tar.zst"];
    for (const d of double) {
      if (lower.endsWith(d)) {
        return { base: name.slice(0, -d.length), ext: d.slice(1) };
      }
    }
    const i = name.lastIndexOf(".");
    if (i <= 0) return { base: name, ext: "" };
    return { base: name.slice(0, i), ext: name.slice(i+1) };
  }

  function toTitleFromFilename(base) {
    return String(base || "")
      .replace(/[_\\.]+/g, " ")
      .replace(/\\s+/g, " ")
      .trim()
      .split(" ")
      .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : "")
      .join(" ");
  }

  function updateKey() {
    const slug = slugify($("slug").value);
    $("slug").value = slug;

    const file = $("file").files[0];
    const { ext } = file ? splitExt(file.name) : { ext: "" };
    const safeExt = (ext || "bin").toLowerCase();

    $("key").value = slug ? `games/${slug}.${safeExt}` : "";
  }

  $("file").addEventListener("change", () => {
    const f = $("file").files[0];
    if (!f) return;

    const { base, ext } = splitExt(f.name);
    const slug = slugify(base);
    $("slug").value = slug;
    $("title").value = $("title").value.trim() ? $("title").value : toTitleFromFilename(base);
    $("key").value = `games/${slug}.${(ext || "bin").toLowerCase()}`;

    $("total").textContent = bytesFmt(f.size);
    $("bytes").textContent = bytesFmt(0);
    barFill.style.width = "0%";
    logEl.textContent = "";
    log(`File: ${f.name} (${bytesFmt(f.size)})`);
  });

  $("slug").addEventListener("input", updateKey);

  async function api(path, { method="GET", token, body, headers={} } = {}) {
    const h = new Headers(headers);
    h.set("Authorization", `Bearer ${token}`);
    if (body && !(body instanceof Blob)) h.set("content-type", "application/json; charset=utf-8");

    const res = await fetch(path, {
      method,
      headers: h,
      body: body ? (body instanceof Blob ? body : JSON.stringify(body)) : undefined,
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = (data && data.error) ? data.error : text || res.statusText;
      throw new Error(`${res.status} ${msg}`);
    }
    return data;
  }

  async function uploadSequential(file, token, key, uploadId) {
    const totalParts = Math.ceil(file.size / CHUNK_SIZE);
    const parts = [];
    let uploaded = 0;

    for (let i = 0; i < totalParts; i++) {
      const partNumber = i + 1;
      const start = i * CHUNK_SIZE;
      const end = Math.min(file.size, start + CHUNK_SIZE);
      const chunk = file.slice(start, end);

      $("status").textContent = `Uploading part ${partNumber}/${totalParts}...`;
      const q = new URLSearchParams({ key, uploadId, partNumber: String(partNumber) });
      const part = await api(`/api/admin/mpu-uploadpart?${q.toString()}`, {
        method: "PUT",
        token,
        body: chunk,
        headers: { "content-type": "application/octet-stream" },
      });

      parts.push(part);
      uploaded += (end - start);

      $("bytes").textContent = bytesFmt(uploaded);
      barFill.style.width = Math.floor((uploaded / file.size) * 100) + "%";
      log(`✓ Part ${partNumber}: etag=${part.etag}`);
    }

    return parts;
  }

  $("btnAbort").addEventListener("click", async () => {
    const token = $("token").value.trim();
    if (!token || !current.key || !current.uploadId) return;

    try {
      $("btnAbort").disabled = true;
      log("Aborting multipart upload...");
      await api("/api/admin/mpu-abort", {
        method: "POST",
        token,
        body: { key: current.key, uploadId: current.uploadId },
      });
      log("✓ Aborted.");
      $("status").textContent = "Aborted.";
    } catch (e) {
      log("Abort error: " + e.message);
    } finally {
      current = { key: null, uploadId: null };
    }
  });

  $("btnUpload").addEventListener("click", async () => {
    const token = $("token").value.trim();
    const file = $("file").files[0];

    const slug = $("slug").value.trim();
    const key = $("key").value.trim();

    if (!token) return alert("ADMIN_TOKEN wajib diisi.");
    if (!file) return alert("Pilih file dulu.");
    if (!slug || !key) return alert("Slug/key belum valid.");

    $("btnUpload").disabled = true;
    $("btnAbort").disabled = false;
    $("status").textContent = "Starting...";

    try {
      // 1) Create MPU
      log("Creating multipart upload...");
      const created = await api("/api/admin/mpu-create", {
        method: "POST",
        token,
        body: { key, contentType: "application/octet-stream" },
      });

      current.key = created.key;
      current.uploadId = created.uploadId;

      log(`✓ uploadId=${created.uploadId}`);

      // 2) Upload parts
      const parts = await uploadSequential(file, token, created.key, created.uploadId);

      // 3) Complete MPU
      $("status").textContent = "Completing upload...";
      log("Completing multipart upload...");
      await api("/api/admin/mpu-complete", {
        method: "POST",
        token,
        body: { key: created.key, uploadId: created.uploadId, parts },
      });
      log("✓ Upload complete (R2).");

      // 4) Upsert D1
      $("status").textContent = "Saving metadata...";
      log("Upserting D1 record...");
      const up = await api("/api/admin/game-upsert", {
        method: "POST",
        token,
        body: {
          title: $("title").value.trim() || slug,
          slug,
          genre: $("genre").value.trim() || null,
          platform: $("platform").value.trim() || null,
          cover_url: $("cover_url").value.trim() || null,
          short_desc: $("short_desc").value.trim() || null,
          is_published: $("is_published").value === "1",
          file_key: created.key,
          file_name: file.name,
          file_size_bytes: file.size,
          sha256: null,
        },
      });

      log("✓ D1 saved. slug=" + up.game.slug);
      $("status").textContent = "DONE ✅";

      log("\\nCek publik:");
      log(`- /api/games?page=1&limit=15`);
      log(`- /api/download/${up.game.slug}`);

    } catch (e) {
      log("ERROR: " + e.message);
      $("status").textContent = "ERROR ❌";
      alert(e.message);

      // kalau gagal setelah create, user bisa klik Abort
    } finally {
      $("btnUpload").disabled = false;
    }
  });
</script>
</body>
</html>
