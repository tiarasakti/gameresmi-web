<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Manage • gameresmi</title>
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui;margin:0;background:#0b1020;color:#e9eeff}
    .wrap{max-width:1100px;margin:34px auto;padding:0 16px}
    .card{background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    h1{margin:0 0 10px;font-size:20px}
    .muted{opacity:.8;font-size:12px}
    input,textarea,button,select{font:inherit}
    input,textarea,select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);
      background:#0e1630;color:#e9eeff;box-sizing:border-box
    }
    textarea{min-height:88px;resize:vertical}
    .row{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr;gap:10px}
    @media (max-width: 920px){ .row{grid-template-columns:1fr; } }
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:0;background:#4aa3ff;color:#071022;cursor:pointer;font-weight:800}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn2{background:rgba(255,255,255,.08);color:#e9eeff;border:1px solid rgba(255,255,255,.12)}
    .danger{background:#ff5b6e;color:#1a0b10}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;opacity:.8;text-align:left;padding:0 10px}
    td{background:#0e1630;border:1px solid rgba(255,255,255,.10);padding:10px;border-left:0;border-right:0}
    tr td:first-child{border-left:1px solid rgba(255,255,255,.10);border-top-left-radius:12px;border-bottom-left-radius:12px}
    tr td:last-child{border-right:1px solid rgba(255,255,255,.10);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .cover{width:54px;height:54px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);object-fit:cover}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .pager{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-top:10px;flex-wrap:wrap}
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{max-width:760px;width:100%;background:#121a33;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
    .modal h2{margin:0 0 10px;font-size:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 820px){ .grid2{grid-template-columns:1fr;} }
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1>Admin Manage</h1>
          <div class="muted">Kelola game (edit, publish/draft, cover, hapus). Token disimpan di session browser (bukan server).</div>
        </div>
        <div class="actions">
          <a class="btn btn2" href="/admin/upload.html">Upload</a>
          <a class="btn btn2" href="/">Home</a>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label class="muted">ADMIN_TOKEN (Bearer)</label>
          <input id="token" type="password" placeholder="Tempel token..." />
        </div>
        <div>
          <label class="muted">Search</label>
          <input id="q" placeholder="judul / slug..." />
        </div>
        <div>
          <label class="muted">Genre</label>
          <select id="genre">
            <option value="">(Semua)</option>
          </select>
        </div>
        <div>
          <label class="muted">Status</label>
          <select id="published">
            <option value="all">(Semua)</option>
            <option value="1">Published</option>
            <option value="0">Draft</option>
          </select>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="btnLoad" class="btn">Refresh</button>
        <span id="info" class="muted"></span>
      </div>

      <div style="overflow:auto;margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Cover</th>
              <th>Game</th>
              <th>Genre</th>
              <th>Platform</th>
              <th>Publish</th>
              <th>Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="pager">
        <div class="muted">Page: <span class="pill" id="pagePill">1</span> • Total: <span class="pill" id="totalPill">0</span></div>
        <div class="actions">
          <button id="prev" class="btn btn2">Prev</button>
          <button id="next" class="btn btn2">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="backdrop" class="modalBackdrop">
    <div class="modal">
      <div class="topbar">
        <h2>Edit Game</h2>
        <button class="btn btn2" id="closeModal">Tutup</button>
      </div>
      <div class="muted">Slug: <span class="mono" id="m_slug"></span></div>
      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label class="muted">Title</label>
          <input id="m_title" />
        </div>
        <div>
          <label class="muted">Platform</label>
          <input id="m_platform" placeholder="PC, PS2, Switch..." />
        </div>
        <div>
          <label class="muted">Genre</label>
          <input id="m_genre" placeholder="Action, RPG..." />
        </div>
        <div>
          <label class="muted">Publish?</label>
          <select id="m_pub">
            <option value="1">Published</option>
            <option value="0">Draft</option>
          </select>
        </div>
      </div>

      <label class="muted" style="margin-top:10px">Deskripsi singkat</label>
      <textarea id="m_desc"></textarea>

      <div class="grid2" style="margin-top:10px;align-items:center">
        <div>
          <label class="muted">Cover URL (auto kalau upload cover)</label>
          <input id="m_cover_url" placeholder="/api/asset?key=covers/..." />
        </div>
        <div>
          <label class="muted">Upload cover dari PC (opsional)</label>
          <input id="m_cover_file" type="file" accept="image/*" />
        </div>
      </div>

      <div class="actions" style="margin-top:12px;justify-content:space-between">
        <div class="actions">
          <button id="save" class="btn">Simpan</button>
          <button id="del" class="btn danger">Hapus</button>
        </div>
        <span id="m_info" class="muted"></span>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let state = {
    page: 1,
    limit: 20,
    totalPages: 1,
    items: [],
    genres: new Set(),
    editing: null,
  };

  function saveToken() {
    sessionStorage.setItem("ADMIN_TOKEN", $("token").value.trim());
  }
  function loadToken() {
    const t = sessionStorage.getItem("ADMIN_TOKEN") || "";
    if (t) $("token").value = t;
  }

  async function api(path, { method="GET", token, body, headers={} } = {}) {
    const h = new Headers(headers);
    if (token) h.set("Authorization", `Bearer ${token}`);
    if (body && !(body instanceof FormData) && !(body instanceof Blob)) {
      h.set("content-type", "application/json; charset=utf-8");
    }

    const res = await fetch(path, {
      method,
      headers: h,
      body: body ? (body instanceof FormData || body instanceof Blob ? body : JSON.stringify(body)) : undefined,
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = (data && data.error) ? data.error : (text || res.statusText);
      throw new Error(`${res.status} ${msg}`);
    }
    return data;
  }

  function fmtDate(s) {
    if (!s) return "-";
    return String(s).replace("T", " ").slice(0, 19);
  }

  function rebuildGenreSelect() {
    const sel = $("genre");
    const cur = sel.value;
    sel.innerHTML = `<option value="">(Semua)</option>`;
    [...state.genres].filter(Boolean).sort().forEach(g => {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      sel.appendChild(opt);
    });
    sel.value = cur;
  }

  function render() {
    $("pagePill").textContent = String(state.page);
    $("totalPill").textContent = String(state.items.length ? state.items.length : 0);

    const tbody = $("rows");
    tbody.innerHTML = "";

    for (const it of state.items) {
      const tr = document.createElement("tr");

      const cover = it.cover_url ? it.cover_url : "";
      const img = cover ? `<img class="cover" src="${cover}" alt="cover" />` : `<div class="cover"></div>`;

      tr.innerHTML = `
        <td style="width:70px">${img}</td>
        <td>
          <div style="font-weight:800">${escapeHtml(it.title || "-")}</div>
          <div class="muted mono">${escapeHtml(it.slug || "-")}</div>
          <div class="muted">File: <span class="mono">${escapeHtml(it.file_name || "-")}</span></div>
        </td>
        <td>${escapeHtml(it.genre || "-")}</td>
        <td>${escapeHtml(it.platform || "-")}</td>
        <td>
          <label class="toggle">
            <input type="checkbox" ${Number(it.is_published) === 1 ? "checked" : ""} data-slug="${escapeAttr(it.slug)}" class="pubToggle" />
            <span class="pill">${Number(it.is_published) === 1 ? "Published" : "Draft"}</span>
          </label>
        </td>
        <td class="muted">${escapeHtml(fmtDate(it.updated_at))}</td>
        <td>
          <div class="actions">
            <button class="btn btn2 editBtn" data-slug="${escapeAttr(it.slug)}">Edit</button>
            <button class="btn btn2 copyBtn" data-slug="${escapeAttr(it.slug)}">Copy Link</button>
            <a class="btn btn2" href="/api/download/${encodeURIComponent(it.slug)}" target="_blank">Download</a>
          </div>
        </td>
      `;

      tbody.appendChild(tr);
    }

    // bind toggles
    document.querySelectorAll(".pubToggle").forEach(el => {
      el.addEventListener("change", async (e) => {
        const token = $("token").value.trim();
        saveToken();
        const slug = e.target.dataset.slug;
        const on = e.target.checked;

        try {
          $("info").textContent = "Updating publish...";
          await api("/api/admin/game-update", {
            method: "POST",
            token,
            body: { slug, is_published: on },
          });
          $("info").textContent = "OK";
          await load();
        } catch (err) {
          $("info").textContent = err.message;
          alert(err.message);
          await load();
        }
      });
    });

    document.querySelectorAll(".editBtn").forEach(btn => {
      btn.addEventListener("click", () => openEdit(btn.dataset.slug));
    });

    document.querySelectorAll(".copyBtn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const slug = btn.dataset.slug;
        const link = `${location.origin}/api/download/${encodeURIComponent(slug)}`;
        try {
          await navigator.clipboard.writeText(link);
          $("info").textContent = "Link disalin.";
        } catch {
          $("info").textContent = link;
        }
      });
    });
  }

  function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g, "&quot;"); }

  async function load() {
    const token = $("token").value.trim();
    saveToken();

    const q = $("q").value.trim();
    const genre = $("genre").value;
    const published = $("published").value;

    $("info").textContent = "Loading...";

    const qs = new URLSearchParams({
      page: String(state.page),
      limit: String(state.limit),
      q,
      genre,
      published,
    });

    const data = await api(`/api/admin/games?${qs.toString()}`, { token });
    state.items = data.items || [];
    state.totalPages = Number(data.totalPages || 1);

    // build genres
    state.genres = new Set();
    for (const it of state.items) if (it.genre) state.genres.add(it.genre);
    rebuildGenreSelect();

    $("info").textContent = `OK • totalPages=${state.totalPages}`;
    render();
  }

  // modal edit
  function openEdit(slug) {
    const it = state.items.find(x => x.slug === slug);
    if (!it) return;

    state.editing = it;
    $("m_slug").textContent = it.slug;
    $("m_title").value = it.title || "";
    $("m_platform").value = it.platform || "";
    $("m_genre").value = it.genre || "";
    $("m_pub").value = String(Number(it.is_published) === 1 ? 1 : 0);
    $("m_desc").value = it.short_desc || "";
    $("m_cover_url").value = it.cover_url || "";
    $("m_cover_file").value = "";

    $("m_info").textContent = "";
    $("backdrop").style.display = "flex";
  }

  function closeEdit() {
    $("backdrop").style.display = "none";
    state.editing = null;
  }

  $("closeModal").addEventListener("click", closeEdit);
  $("backdrop").addEventListener("click", (e) => { if (e.target === $("backdrop")) closeEdit(); });

  $("save").addEventListener("click", async () => {
    const token = $("token").value.trim();
    saveToken();
    if (!state.editing) return;

    try {
      $("m_info").textContent = "Saving...";

      let coverUrl = $("m_cover_url").value.trim() || null;

      // kalau ada file cover, upload dulu
      const f = $("m_cover_file").files[0];
      if (f) {
        const form = new FormData();
        form.set("slug", state.editing.slug);
        form.set("file", f);

        const up = await api("/api/admin/cover-upload", { method: "POST", token, body: form });
        coverUrl = up.url; // /api/asset?key=covers/...
        $("m_cover_url").value = coverUrl;
      }

      await api("/api/admin/game-update", {
        method: "POST",
        token,
        body: {
          slug: state.editing.slug,
          title: $("m_title").value.trim() || state.editing.slug,
          platform: $("m_platform").value.trim() || null,
          genre: $("m_genre").value.trim() || null,
          short_desc: $("m_desc").value.trim() || null,
          cover_url: coverUrl,
          is_published: $("m_pub").value === "1",
        },
      });

      $("m_info").textContent = "OK ✅";
      await load();
      closeEdit();
    } catch (err) {
      $("m_info").textContent = err.message;
      alert(err.message);
    }
  });

  $("del").addEventListener("click", async () => {
    const token = $("token").value.trim();
    saveToken();
    if (!state.editing) return;

    const slug = state.editing.slug;
    const sure = confirm(`Hapus "${slug}" dari database?`);
    if (!sure) return;

    const delFile = confirm("Sekalian hapus file ZIP di R2 juga? (OK=hapus file, Cancel=hapus DB saja)");
    try {
      $("m_info").textContent = "Deleting...";
      await api("/api/admin/game-delete", {
        method: "POST",
        token,
        body: { slug, delete_file: delFile },
      });
      $("m_info").textContent = "Deleted ✅";
      await load();
      closeEdit();
    } catch (err) {
      $("m_info").textContent = err.message;
      alert(err.message);
    }
  });

  // pager + filters
  $("btnLoad").addEventListener("click", async () => { state.page = 1; await load(); });
  $("prev").addEventListener("click", async () => { state.page = Math.max(1, state.page - 1); await load(); });
  $("next").addEventListener("click", async () => { state.page = Math.min(state.totalPages, state.page + 1); await load(); });

  $("q").addEventListener("keydown", async (e) => { if (e.key === "Enter") { state.page = 1; await load(); } });
  $("genre").addEventListener("change", async () => { state.page = 1; await load(); });
  $("published").addEventListener("change", async () => { state.page = 1; await load(); });
  $("token").addEventListener("change", saveToken);

  // init
  loadToken();
  // kalau token sudah ada, langsung load
  if ($("token").value.trim()) load().catch(err => $("info").textContent = err.message);
</script>
</body>
</html>
