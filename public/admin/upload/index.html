<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Upload</title>
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui;margin:0;background:#0b1020;color:#e9eeff}
    .wrap{max-width:1020px;margin:34px auto;padding:0 16px}
    .card{background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    h1{margin:0;font-size:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .nav{display:flex;gap:10px;align-items:center}
    a.btn{ text-decoration:none; }
    label{display:block;font-size:12px;opacity:.9;margin:12px 0 6px}
    input,textarea,button,select{font:inherit}
    input,textarea,select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);
      background:#0e1630;color:#e9eeff;box-sizing:border-box
    }
    textarea{min-height:88px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{opacity:.8;font-size:12px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:0;background:#4aa3ff;color:#071022;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:rgba(255,255,255,.08);color:#e9eeff;border:1px solid rgba(255,255,255,.12)}
    .danger{background:#ff5b6e;color:#1a0b10}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar > div{height:100%;width:0%;background:#4aa3ff}
    .kpi{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px}
    .kpi div{font-size:12px;opacity:.9}
    .preview{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .img{width:74px;height:74px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0e1630;object-fit:cover}
    .small{font-size:12px;opacity:.85}
    .addRow{display:flex;gap:8px;margin-top:8px}
    .addRow input{flex:1}
    .addRow select{flex:1}

    .picked{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(74,163,255,.14);
      border:1px solid rgba(74,163,255,.22);
      font-size:12px;font-weight:800
    }
    .chip button{
      width:22px;height:22px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.9);
      cursor:pointer;line-height:1;font-weight:900
    }
    .chip button:hover{filter:brightness(1.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Admin Upload (R2 Multipart + D1)</h1>
          <div class="muted">Chunk <span class="pill">20 MB</span> • Key: <span class="pill mono">games/&lt;slug&gt;.&lt;ext&gt;</span></div>
        </div>
        <div class="nav">
          <a class="btn ghost" href="/admin/manage">Manage</a>
          <a class="btn ghost" href="/">Home</a>
        </div>
      </div>

      <label>ADMIN_TOKEN (Bearer)</label>
      <input id="token" type="password" placeholder="Tempel token (disimpan di session browser)" />

      <label>File game</label>
      <input id="file" type="file" />

      <div class="row">
        <div>
          <label>Slug (auto, bisa edit)</label>
          <input id="slug" placeholder="mis: gta-san-andreas" />
        </div>
        <div>
          <label>File key (terkunci)</label>
          <input id="key" readonly />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Title</label>
          <input id="title" placeholder="Judul game" />
        </div>
        <div>
          <label>Cover (upload dari PC)</label>
          <input id="cover" name="cover" type="file" accept="image/*" required />
          <div class="preview">
            <img id="coverPreview" class="img" alt="cover preview" />
            <div class="small" id="coverInfo">Belum ada cover dipilih.</div>
          </div>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Genre (bisa lebih dari 1)</label>

          <div class="addRow">
            <select id="genre"></select>
            <button id="btnPickGenre" class="btn ghost" type="button">+ Genre</button>
          </div>

          <div class="picked" id="genrePicked"></div>
          <div class="small">Tip: pilih genre lalu klik <b>+ Genre</b>. Bisa hapus per chip.</div>

          <div class="addRow" style="margin-top:10px">
            <input id="genreNew" placeholder="Tambah genre baru..." />
            <button id="btnAddGenre" class="btn ghost" type="button">Simpan</button>
          </div>
        </div>

        <div>
          <label>Platform (opsional)</label>
          <input id="platform" placeholder="PC, PS2, Switch, ..." />
        </div>

        <div>
          <label>Publish?</label>
          <select id="is_published">
            <option value="1" selected>Ya</option>
            <option value="0">Tidak (draft)</option>
          </select>
        </div>
      </div>

      <label>Deskripsi singkat (opsional)</label>
      <textarea id="short_desc" placeholder="Ringkasan singkat untuk grid"></textarea>

      <div style="display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <button id="btnUpload" class="btn">Upload</button>
        <button id="btnAbort" class="btn danger" disabled>Abort</button>
        <span id="status" class="muted"></span>
      </div>

      <div style="margin-top:12px" class="bar"><div id="barFill"></div></div>
      <div class="kpi">
        <div>Uploaded: <span class="mono" id="bytes">0</span> / <span class="mono" id="total">0</span></div>
        <div>Speed: <span class="mono" id="speed">0 MB/s</span> (avg <span class="mono" id="speedAvg">0 MB/s</span>)</div>
      </div>
    </div>
  </div>

<script>
  const CHUNK_SIZE = 20 * 1024 * 1024;
  let current = { key: null, uploadId: null };

  const $ = (id) => document.getElementById(id);
  const barFill = $("barFill");

  function bytesFmt(n) {
    const u = ["B","KB","MB","GB","TB"];
    let i = 0, x = Number(n || 0);
    while (x >= 1024 && i < u.length-1) { x /= 1024; i++; }
    return x.toFixed(i === 0 ? 0 : 2) + " " + u[i];
  }
  function mbps(bytes, ms) {
    const sec = ms / 1000;
    if (!sec) return 0;
    return (bytes / 1024 / 1024) / sec;
  }
  function escHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function slugify(s) {
    return String(s || "")
      .normalize("NFKD").replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
  }
  function splitExt(filename) {
    const name = String(filename || "");
    const i = name.lastIndexOf(".");
    if (i <= 0) return { base: name, ext: "" };
    return { base: name.slice(0, i), ext: name.slice(i+1) };
  }
  function toTitleFromFilename(base) {
    return String(base || "")
      .replace(/[_\.]+/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .split(" ")
      .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : "")
      .join(" ");
  }

  function updateKey() {
    const slug = slugify($("slug").value);
    $("slug").value = slug;

    const file = $("file").files[0];
    const { ext } = file ? splitExt(file.name) : { ext: "" };
    const safeExt = (ext || "bin").toLowerCase();

    $("key").value = slug ? `games/${slug}.${safeExt}` : "";
  }

  // token session
  const savedToken = sessionStorage.getItem("ADMIN_TOKEN") || "";
  if (savedToken) $("token").value = savedToken;
  $("token").addEventListener("input", () => {
    sessionStorage.setItem("ADMIN_TOKEN", $("token").value.trim());
  });

  // genres list (localStorage)
  const DEFAULT_GENRES = ["Action","Adventure","RPG","Simulation","Strategy","Puzzle","Horror","Sports","Racing","Casual"];
  function loadGenres() {
    try {
      const x = JSON.parse(localStorage.getItem("ADMIN_GENRES") || "null");
      return Array.isArray(x) && x.length ? x : DEFAULT_GENRES;
    } catch { return DEFAULT_GENRES; }
  }
  function saveGenres(arr) {
    localStorage.setItem("ADMIN_GENRES", JSON.stringify(arr));
  }
  function renderGenres(selected) {
    const arr = loadGenres();
    $("genre").innerHTML = arr.map(g => `<option value="${escHtml(g)}">${escHtml(g)}</option>`).join("");
    if (selected && arr.includes(selected)) $("genre").value = selected;
  }
  renderGenres();

  // ===== Multi-genre state =====
  let selectedGenres = [];

  function renderPickedGenres(){
    const box = $("genrePicked");
    if (!box) return;

    if (!selectedGenres.length){
      box.innerHTML = `<span class="muted">Belum ada genre dipilih.</span>`;
      return;
    }

    box.innerHTML = selectedGenres.map(g => {
      const safeLabel = escHtml(g);
      const safeKey = encodeURIComponent(g);
      return `
        <span class="chip">
          ${safeLabel}
          <button type="button" data-del="${safeKey}" aria-label="Hapus ${safeLabel}">×</button>
        </span>
      `;
    }).join("");

    box.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const g = decodeURIComponent(btn.getAttribute("data-del") || "");
        selectedGenres = selectedGenres.filter(x => x !== g);
        renderPickedGenres();
      });
    });
  }

  function addGenreToSelected(g){
    g = String(g || "").trim();
    if (!g) return;
    if (!selectedGenres.includes(g)) selectedGenres.push(g);
    renderPickedGenres();
  }

  function getGenresForSave(){
    const arr = (selectedGenres || []).map(x => String(x || "").trim()).filter(Boolean);
    if (arr.length) return arr;
    const one = String($("genre").value || "").trim();
    return one ? [one] : [];
  }

  renderPickedGenres();

  const btnPickGenre = $("btnPickGenre");
  if (btnPickGenre){
    btnPickGenre.addEventListener("click", () => addGenreToSelected($("genre").value));
  }

  $("btnAddGenre").addEventListener("click", () => {
    const g = $("genreNew").value.trim();
    if (!g) return;

    const arr = loadGenres();
    if (!arr.includes(g)) arr.unshift(g);
    saveGenres(arr);
    renderGenres(g);

    addGenreToSelected(g);
    $("genreNew").value = "";
  });

  // cover preview
  $("cover").addEventListener("change", () => {
    const f = $("cover").files[0];
    if (!f) {
      $("coverPreview").src = "";
      $("coverInfo").textContent = "Belum ada cover dipilih.";
      return;
    }
    $("coverPreview").src = URL.createObjectURL(f);
    $("coverInfo").textContent = `${f.name} (${bytesFmt(f.size)})`;
  });

  $("file").addEventListener("change", () => {
    const f = $("file").files[0];
    if (!f) return;

    selectedGenres = [];
    renderPickedGenres();

    const { base, ext } = splitExt(f.name);
    const slug = slugify(base);
    $("slug").value = slug;
    $("title").value = $("title").value.trim() ? $("title").value : toTitleFromFilename(base);
    $("key").value = `games/${slug}.${(ext || "bin").toLowerCase()}`;

    $("total").textContent = bytesFmt(f.size);
    $("bytes").textContent = bytesFmt(0);
    $("speed").textContent = "0 MB/s";
    $("speedAvg").textContent = "0 MB/s";
    barFill.style.width = "0%";
    $("status").textContent = "Siap upload.";
  });

  $("slug").addEventListener("input", updateKey);

  async function apiJson(path, { method="GET", token, body, headers={} } = {}) {
    const h = new Headers(headers);
    h.set("Authorization", `Bearer ${token}`);
    if (body) h.set("content-type", "application/json; charset=utf-8");

    const res = await fetch(path, { method, headers: h, body: body ? JSON.stringify(body) : undefined });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) throw new Error(`${res.status} ${(data && data.error) ? data.error : (text || res.statusText)}`);
    return data;
  }

  async function apiBlob(path, { method="PUT", token, body, headers={} } = {}) {
    const h = new Headers(headers);
    h.set("Authorization", `Bearer ${token}`);
    const res = await fetch(path, { method, headers: h, body });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) throw new Error(`${res.status} ${(data && data.error) ? data.error : (text || res.statusText)}`);
    return data;
  }

  function makeCoverUrlFromKey(key){
    // jika backend kamu pakai /api/cover/<key>, ganti baris ini:
    return `/api/cover?key=${encodeURIComponent(key)}`;
  }

  function normalizeCoverResponse(data){
    // terima banyak kemungkinan nama field
    const url =
      data?.cover_url ||
      data?.coverUrl ||
      data?.url ||
      data?.cover ||
      null;

    const key =
      data?.key ||
      data?.cover_key ||
      data?.coverKey ||
      data?.r2_key ||
      data?.object_key ||
      null;

    // kalau "url" isinya cuma key/path (mis: covers/x.webp), ubah jadi endpoint cover
    const looksLikeKey = (v) => v && !String(v).startsWith("http") && !String(v).startsWith("/") && String(v).includes("/");
    const looksLikeRelativeKey = (v) => v && !String(v).startsWith("http") && String(v).includes("/");

    if (url && looksLikeKey(url)) return { cover_url: makeCoverUrlFromKey(url), raw: data };
    if (url && looksLikeRelativeKey(url) && !String(url).startsWith("/api/")) {
      // contoh: "covers/abc.webp" -> /api/cover?key=covers/abc.webp
      return { cover_url: makeCoverUrlFromKey(url), raw: data };
    }

    if (url) return { cover_url: String(url), raw: data };
    if (key) return { cover_url: makeCoverUrlFromKey(key), raw: data };
    return { cover_url: null, raw: data };
  }

  // cover upload: field HARUS "cover"
  async function uploadCoverIfAny(token, slug) {
    const f = $("cover").files?.[0];
    if (!f) return null;

    const fd = new FormData();
    fd.append("slug", slug);
    fd.append("cover", f, f.name);

    const res = await fetch("/api/admin/cover-upload", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` },
      body: fd
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) throw new Error(`${res.status} ${(data && data.error) ? data.error : (text || res.statusText)}`);

    const norm = normalizeCoverResponse(data || {});
    if (!norm.cover_url){
      // biar gak “sukses tapi kosong”
      throw new Error(`Cover upload sukses tapi tidak mengembalikan cover_url/key. Response: ${text.slice(0,200)}`);
    }

    return norm.cover_url;
  }

  async function uploadSequential(file, token, key, uploadId) {
    const totalParts = Math.ceil(file.size / CHUNK_SIZE);
    const parts = [];
    let uploaded = 0;

    const t0 = performance.now();
    let lastT = t0;
    let lastUploaded = 0;

    for (let i = 0; i < totalParts; i++) {
      const partNumber = i + 1;
      const start = i * CHUNK_SIZE;
      const end = Math.min(file.size, start + CHUNK_SIZE);
      const chunk = file.slice(start, end);

      $("status").textContent = `Uploading part ${partNumber}/${totalParts}...`;
      const q = new URLSearchParams({ key, uploadId, partNumber: String(partNumber) });

      const part = await apiBlob(`/api/admin/mpu-uploadpart?${q.toString()}`, {
        method: "PUT",
        token,
        body: chunk,
        headers: { "content-type": "application/octet-stream" },
      });

      parts.push(part);
      uploaded += (end - start);

      $("bytes").textContent = bytesFmt(uploaded);
      barFill.style.width = Math.floor((uploaded / file.size) * 100) + "%";

      const now = performance.now();
      const inst = mbps((uploaded - lastUploaded), (now - lastT));
      const avg = mbps(uploaded, (now - t0));
      $("speed").textContent = inst.toFixed(2) + " MB/s";
      $("speedAvg").textContent = avg.toFixed(2) + " MB/s";
      lastT = now;
      lastUploaded = uploaded;
    }

    return parts;
  }

  $("btnAbort").addEventListener("click", async () => {
    const token = $("token").value.trim();
    if (!token || !current.key || !current.uploadId) return;

    try {
      $("btnAbort").disabled = true;
      $("status").textContent = "Aborting...";
      await apiJson("/api/admin/mpu-abort", {
        method: "POST",
        token,
        body: { key: current.key, uploadId: current.uploadId },
      });
      $("status").textContent = "Aborted.";
    } catch (e) {
      alert("Abort error: " + e.message);
    } finally {
      current = { key: null, uploadId: null };
    }
  });

  function resetFormAfterSuccess() {
    $("file").value = "";
    $("cover").value = "";
    $("slug").value = "";
    $("key").value = "";
    $("title").value = "";
    $("platform").value = "";
    $("short_desc").value = "";
    $("genreNew").value = "";

    renderGenres();
    $("genre").selectedIndex = 0;
    $("is_published").value = "1";

    selectedGenres = [];
    renderPickedGenres();

    $("coverPreview").src = "";
    $("coverInfo").textContent = "Belum ada cover dipilih.";

    barFill.style.width = "0%";
    $("bytes").textContent = bytesFmt(0);
    $("total").textContent = bytesFmt(0);
    $("speed").textContent = "0 MB/s";
    $("speedAvg").textContent = "0 MB/s";

    $("status").textContent = "Siap upload.";
    $("btnAbort").disabled = true;
    current = { key: null, uploadId: null };

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  $("btnUpload").addEventListener("click", async () => {
    const token = $("token").value.trim();
    const file = $("file").files[0];

    const slug = $("slug").value.trim();
    const key = $("key").value.trim();

    const coverFile = $("cover").files?.[0];

    if (!token) return alert("ADMIN_TOKEN wajib diisi.");
    if (!file) return alert("Pilih file game dulu.");
    if (!slug || !key) return alert("Slug/key belum valid.");
    if (!coverFile) return alert("Pilih cover dulu.");

    $("btnUpload").disabled = true;
    $("btnAbort").disabled = false;
    $("status").textContent = "Starting...";

    try {
      // 1) create MPU
      $("status").textContent = "Creating multipart upload...";
      const created = await apiJson("/api/admin/mpu-create", {
        method: "POST",
        token,
        body: { key, contentType: "application/octet-stream" },
      });

      current.key = created.key;
      current.uploadId = created.uploadId;

      // 2) upload parts
      const parts = await uploadSequential(file, token, created.key, created.uploadId);

      // 3) complete
      $("status").textContent = "Completing upload...";
      await apiJson("/api/admin/mpu-complete", {
        method: "POST",
        token,
        body: { key: created.key, uploadId: created.uploadId, parts },
      });

      const genresArr = getGenresForSave();
      const genreToSave = genresArr.length ? genresArr.join(", ") : null;

      // 4) upsert awal (boleh null cover)
      $("status").textContent = "Saving metadata (initial)...";
      await apiJson("/api/admin/game-upsert", {
        method: "POST",
        token,
        body: {
          title: $("title").value.trim() || slug,
          slug,
          genre: genreToSave,
          platform: $("platform").value.trim() || null,
          cover_url: null,
          short_desc: $("short_desc").value.trim() || null,
          is_published: $("is_published").value === "1",
          file_key: created.key,
          file_name: file.name,
          file_size_bytes: file.size,
          sha256: null,
        },
      });

      // 5) upload cover (FIX)
      $("status").textContent = "Uploading cover...";
      const coverUrl = await uploadCoverIfAny(token, slug);

      // optional: update preview biar yakin gak “kosong”
      $("coverPreview").src = coverUrl;
      $("coverInfo").textContent = `Uploaded ✅ (${coverUrl})`;

      // 6) update metadata lagi dengan cover_url (PASTI string)
      $("status").textContent = "Saving cover url...";
      await apiJson("/api/admin/game-upsert", {
        method: "POST",
        token,
        body: {
          title: $("title").value.trim() || slug,
          slug,
          genre: genreToSave,
          platform: $("platform").value.trim() || null,
          cover_url: String(coverUrl),
          short_desc: $("short_desc").value.trim() || null,
          is_published: $("is_published").value === "1",
          file_key: created.key,
          file_name: file.name,
          file_size_bytes: file.size,
          sha256: null,
        },
      });

      $("status").textContent = "DONE ✅ (cek Home/Manage)";
      resetFormAfterSuccess();
    } catch (e) {
      $("status").textContent = "ERROR ❌";
      alert(e.message);
    } finally {
      $("btnUpload").disabled = false;
    }
  });
</script>
</body>
</html>
