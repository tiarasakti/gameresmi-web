<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Download ‚Ä¢ TSGames</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

  <!-- favicon sama -->
  <link rel="icon" href="/assets/tsgames-logo.png" type="image/png">
  <link rel="apple-touch-icon" href="/assets/tsgames-logo.png">
  <meta name="theme-color" content="#0ea5e9">

  <style>
    :root{
      --bg:#1f2328;
      --text:#e8eaed;
      --muted:rgba(232,234,237,.72);
      --blue:#0ea5e9;
      --blue2:#1d4ed8;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --r:14px;
      --max: 980px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Rajdhani",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(900px 380px at 50% 0%, rgba(14,165,233,.18), transparent 55%),
                  linear-gradient(180deg, #14171a, #1f2328 45%, #1b1f23);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:var(--max);margin:0 auto;padding:22px 16px 40px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-family:"Orbitron",system-ui;
      font-weight:900;
      letter-spacing:.3px;
    }
    .brand img{height:34px;width:auto;display:block}
    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:0;
    }
    @media (max-width:820px){
      .hero{grid-template-columns:1fr}
    }
    .cover{
      background:#0f172a;
      min-height:220px;
      border-right:1px solid rgba(255,255,255,.12);
    }
    .cover img{
      width:100%;height:100%;min-height:220px;
      object-fit:cover;display:block;background:#0f172a;
    }
    .body{padding:16px 16px 18px}
    .title{
      margin:0 0 8px;
      font-size:22px;
      font-weight:1000;
      letter-spacing:.2px;
      line-height:1.2;
      font-family:"Orbitron",system-ui;
    }
    .meta{font-size:13px;color:var(--muted);font-weight:800;margin-bottom:10px}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      font-weight:900;font-size:12px;
    }
    .desc{margin:0 0 14px;color:rgba(255,255,255,.88);line-height:1.65;font-size:14px;font-weight:700}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:0;cursor:pointer;
      font-weight:1000;font-size:13px;
      padding:11px 14px;border-radius:10px;
      background:#0b5e7a;color:#fff;
      transition:filter .12s ease, transform .12s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(14,165,233,1), rgba(29,78,216,1));
      color:#071019;
    }
    .btn.secondary{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.92);
    }
    .note{
      margin-top:14px;
      font-size:12px;
      color: rgba(255,255,255,.72);
      font-weight:800;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <a class="brand" href="/" aria-label="TSGames">
        <img src="/assets/tsgames-logo.png" alt="TSGames">
        <span>TSGames</span>
      </a>
      <a href="/" style="opacity:.9;font-weight:900">‚Üê Kembali</a>
    </div>

    <div class="card">
      <div class="hero">
        <div class="cover">
          <img id="cover" alt="Cover game" />
        </div>

        <div class="body">
          <h1 class="title" id="title">Memuat‚Ä¶</h1>
          <div class="meta">
            Slug: <span class="mono" id="slugText">-</span>
          </div>

          <div class="tags" id="tags"></div>
          <p class="desc" id="desc"></p>

          <div class="actions">
            <a class="btn primary" id="downloadBtn" href="#" rel="noopener">Mulai Download</a>
            <button class="btn secondary" id="copyDirect" type="button">Copy direct link</button>
            <button class="btn secondary" id="copyPage" type="button">Copy halaman ini</button>
          </div>

          <div class="note" id="note"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function fmtBytes(n){
    n = Number(n || 0);
    if (!n) return "-";
    const u = ["B","KB","MB","GB"];
    let i=0;
    while (n >= 1024 && i < u.length-1){ n/=1024; i++; }
    return `${n.toFixed(i===0?0:1)} ${u[i]}`;
  }

  function fmtDate(s){
    if (!s) return "";
    const t = s.replace(" ", "T") + "Z";
    const d = new Date(t);
    if (isNaN(d.getTime())) return s;
    return d.toLocaleDateString("id-ID", { year:"numeric", month:"long", day:"numeric" });
  }

  function placeholderSvg(label){
    const text = (label || "GAME").slice(0, 18);
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="450">
  <defs>
    <linearGradient id="g" x1="0" x2="1">
      <stop offset="0" stop-color="#0ea5e9"/>
      <stop offset="1" stop-color="#1d4ed8"/>
    </linearGradient>
  </defs>
  <rect width="800" height="450" fill="#0f172a"/>
  <rect x="-40" y="-40" width="880" height="530" rx="26" fill="url(#g)" opacity=".22"/>
  <rect x="60" y="70" width="680" height="310" rx="22" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"/>
  <text x="400" y="235" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="42" fill="rgba(255,255,255,.90)" font-weight="800">${esc(text)}</text>
</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  async function fetchGamesByQuery(q){
    const u = new URL("/api/games", location.origin);
    u.searchParams.set("page", "1");
    u.searchParams.set("limit", "25");
    u.searchParams.set("q", q);
    const res = await fetch(u.toString(), { cache: "no-store" });
    const ct = res.headers.get("content-type") || "";
    const text = await res.text();

    if (!ct.includes("application/json")){
      throw new Error(`Response bukan JSON (${res.status})`);
    }
    const data = text ? JSON.parse(text) : {};
    if (!res.ok) throw new Error(data?.error || res.statusText || "Request gagal");
    return data || {};
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      return true;
    }catch{
      alert(txt);
      return false;
    }
  }

  (async function init(){
    const sp = new URLSearchParams(location.search);
    const slug = (sp.get("slug") || "").trim();

    const titleEl = document.getElementById("title");
    const slugText = document.getElementById("slugText");
    const coverEl = document.getElementById("cover");
    const tagsEl = document.getElementById("tags");
    const descEl = document.getElementById("desc");
    const noteEl = document.getElementById("note");
    const downloadBtn = document.getElementById("downloadBtn");
    const copyDirect = document.getElementById("copyDirect");
    const copyPage = document.getElementById("copyPage");

    slugText.textContent = slug || "-";

    if (!slug){
      titleEl.textContent = "Slug tidak ditemukan";
      descEl.textContent = "Link download tidak valid. Kembali ke Home lalu klik Download dari kartu game.";
      coverEl.src = placeholderSvg("TSGames");
      downloadBtn.href = "/";
      downloadBtn.textContent = "Kembali ke Home";
      copyDirect.disabled = true;
      noteEl.textContent = "Catatan: Parameter ?slug= wajib ada.";
      return;
    }

    // direct download URL
    const directUrl = new URL(`/api/download/${encodeURIComponent(slug)}`, location.origin).toString();
    downloadBtn.href = directUrl;

    // cari metadata via /api/games?q=slug (ambil item yang slug-nya exact match)
    try{
      const data = await fetchGamesByQuery(slug);
      const items = Array.isArray(data.items) ? data.items : [];
      const item = items.find(it => String(it.slug || "") === slug) || items[0];

      const title = item?.title || slug;
      const cover = item?.cover_url || placeholderSvg(title);
      const genre = (item?.genre || "").trim();
      const platform = (item?.platform || "").trim();
      const size = fmtBytes(item?.file_size_bytes);
      const date = fmtDate(item?.updated_at);
      const sdesc = (item?.short_desc || "").trim();

      titleEl.textContent = title;
      coverEl.src = cover;
      coverEl.onerror = () => (coverEl.src = placeholderSvg(title));

      const tags = [];
      if (genre) tags.push(`üéØ ${genre}`);
      if (platform) tags.push(`üïπÔ∏è ${platform}`);
      if (size !== "-") tags.push(`üì¶ ${size}`);
      if (date) tags.push(`üóìÔ∏è ${date}`);
      tagsEl.innerHTML = tags.map(t => `<span class="tag">${esc(t)}</span>`).join("");

      descEl.textContent = sdesc || "Klik tombol ‚ÄúMulai Download‚Äù untuk mengambil file game.";
      noteEl.innerHTML = `Jika download tidak mulai, klik kanan tombol download ‚Üí <span class="mono">Save link as‚Ä¶</span> (browser kadang ‚Äúsok tegas‚Äù).`;
    }catch(e){
      titleEl.textContent = slug;
      coverEl.src = placeholderSvg(slug);
      tagsEl.innerHTML = `<span class="tag">‚ö†Ô∏è Metadata tidak tersedia</span>`;
      descEl.textContent = "Halaman tetap bisa dipakai untuk download. Jika katalog sedang error, gunakan tombol download di bawah.";
      noteEl.textContent = "Info: Gagal ambil detail game dari API, tapi direct download tetap disiapkan.";
    }

    copyDirect.addEventListener("click", async () => {
      const ok = await copyText(directUrl);
      if (ok){
        copyDirect.textContent = "Copied ‚úì";
        setTimeout(() => (copyDirect.textContent = "Copy direct link"), 1100);
      }
    });

    copyPage.addEventListener("click", async () => {
      const ok = await copyText(location.href);
      if (ok){
        copyPage.textContent = "Copied ‚úì";
        setTimeout(() => (copyPage.textContent = "Copy halaman ini"), 1100);
      }
    });
  })();
</script>
</body>
</html>
